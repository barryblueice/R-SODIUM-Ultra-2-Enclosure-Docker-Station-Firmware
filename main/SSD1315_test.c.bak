#include <stdio.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/i2c.h"
#include "driver/gpio.h"
#include "esp_log.h"
#include "esp_err.h"

#define TAG "SSD1315_TEXT"

#define I2C_MASTER_NUM       I2C_NUM_0
#define I2C_MASTER_SDA_IO    36
#define I2C_MASTER_SCL_IO    37
#define I2C_MASTER_FREQ_HZ   400000

#define OLED_ADDR            0x3D
#define OLED_WIDTH           128
#define OLED_HEIGHT          64
#define OLED_PAGES           (OLED_HEIGHT / 8)

#define RESET_PIN            5

#define OLED_CMD  0x00
#define OLED_DATA 0x40

static esp_err_t check_ret(esp_err_t r, const char *op) {
    if (r != ESP_OK) {
        ESP_LOGE(TAG, "%s failed: %s", op, esp_err_to_name(r));
    }
    return r;
}

static void i2c_init(void) {
    i2c_config_t conf = {
        .mode = I2C_MODE_MASTER,
        .sda_io_num = I2C_MASTER_SDA_IO,
        .scl_io_num = I2C_MASTER_SCL_IO,
        .sda_pullup_en = GPIO_PULLUP_ENABLE,
        .scl_pullup_en = GPIO_PULLUP_ENABLE,
        .master.clk_speed = I2C_MASTER_FREQ_HZ
    };
    i2c_param_config(I2C_MASTER_NUM, &conf);
    esp_err_t r = i2c_driver_install(I2C_MASTER_NUM, conf.mode, 0, 0, 0);
    check_ret(r, "i2c_driver_install");
}

static void i2c_scan(void) {
    ESP_LOGI(TAG, "I2C scan start");
    for (int addr = 1; addr < 0x7f; ++addr) {
        i2c_cmd_handle_t h = i2c_cmd_link_create();
        i2c_master_start(h);
        i2c_master_write_byte(h, (addr << 1) | I2C_MASTER_WRITE, true);
        i2c_master_stop(h);
        esp_err_t r = i2c_master_cmd_begin(I2C_MASTER_NUM, h, pdMS_TO_TICKS(50));
        i2c_cmd_link_delete(h);
        if (r == ESP_OK) {
            ESP_LOGI(TAG, "Found device at 0x%02X", addr);
        }
    }
    ESP_LOGI(TAG, "I2C scan done");
}

static esp_err_t i2c_write_cmd(uint8_t cmd) {
    i2c_cmd_handle_t h = i2c_cmd_link_create();
    i2c_master_start(h);
    i2c_master_write_byte(h, (OLED_ADDR << 1) | I2C_MASTER_WRITE, true);
    i2c_master_write_byte(h, OLED_CMD, true);
    i2c_master_write_byte(h, cmd, true);
    i2c_master_stop(h);
    esp_err_t r = i2c_master_cmd_begin(I2C_MASTER_NUM, h, pdMS_TO_TICKS(200));
    i2c_cmd_link_delete(h);
    return check_ret(r, "i2c_write_cmd");
}

static esp_err_t i2c_write_data(const uint8_t *data, size_t len) {
    i2c_cmd_handle_t h = i2c_cmd_link_create();
    i2c_master_start(h);
    i2c_master_write_byte(h, (OLED_ADDR << 1) | I2C_MASTER_WRITE, true);
    i2c_master_write_byte(h, OLED_DATA, true);
    i2c_master_write(h, data, len, true);
    i2c_master_stop(h);
    esp_err_t r = i2c_master_cmd_begin(I2C_MASTER_NUM, h, pdMS_TO_TICKS(500));
    i2c_cmd_link_delete(h);
    return check_ret(r, "i2c_write_data");
}

static void oled_hw_reset(void) {
    if (RESET_PIN < 0) return;
    gpio_set_direction(RESET_PIN, GPIO_MODE_OUTPUT);
    gpio_set_level(RESET_PIN, 0);
    vTaskDelay(pdMS_TO_TICKS(20));
    gpio_set_level(RESET_PIN, 1);
    vTaskDelay(pdMS_TO_TICKS(20));
}

static void oled_init(void) {
    vTaskDelay(pdMS_TO_TICKS(50));
    oled_hw_reset();

    i2c_write_cmd(0xAE); // display off
    i2c_write_cmd(0x20); i2c_write_cmd(0x00); // memory addressing mode: horizontal
    i2c_write_cmd(0xB0); // page start address
    i2c_write_cmd(0xC0); // COM scan direction remapped
    i2c_write_cmd(0x00); i2c_write_cmd(0x10); // column addr low/high
    i2c_write_cmd(0x40); // set start line
    i2c_write_cmd(0x81); i2c_write_cmd(0x7F); // contrast (test中值)
    i2c_write_cmd(0xA0); // segment remap
    i2c_write_cmd(0xA6); // normal display
    i2c_write_cmd(0xA8); i2c_write_cmd(0x3F); // multiplex 1/64
    i2c_write_cmd(0xA4); // output follows RAM
    i2c_write_cmd(0xD3); i2c_write_cmd(0x00); // display offset
    i2c_write_cmd(0xD5); i2c_write_cmd(0x80); // display clock divide
    i2c_write_cmd(0xD9); i2c_write_cmd(0x22); // pre-charge
    i2c_write_cmd(0xDA); i2c_write_cmd(0x12); // com pins hardware config
    i2c_write_cmd(0xDB); i2c_write_cmd(0x20); // vcomh
    i2c_write_cmd(0x8D); i2c_write_cmd(0x14); // charge pump on
    i2c_write_cmd(0xAF); // display on
    vTaskDelay(pdMS_TO_TICKS(50));
}

static void oled_set_pos(uint8_t page, uint8_t col) {
    i2c_write_cmd(0xB0 + page);
    i2c_write_cmd(0x00 | (col & 0x0F));
    i2c_write_cmd(0x10 | ((col >> 4) & 0x0F));
}

static void oled_fill_screen(uint8_t value) {
    uint8_t line[OLED_WIDTH];
    for (int i = 0; i < OLED_WIDTH; ++i) line[i] = value;
    for (uint8_t p = 0; p < OLED_PAGES; ++p) {
        oled_set_pos(p, 0);
        esp_err_t r = i2c_write_data(line, OLED_WIDTH);
        if (r != ESP_OK) {
            ESP_LOGE(TAG, "fill failed at page %d", p);
            return;
        }
    }
}

static const uint8_t font8x8_basic[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 0x20 ' '
    {0x00,0x00,0x5F,0x00,0x00,0x00,0x00,0x00}, // 0x21 '!'
    {0x00,0x07,0x00,0x07,0x00,0x00,0x00,0x00}, // 0x22 '"'
    {0x14,0x7F,0x14,0x7F,0x14,0x00,0x00,0x00}, // 0x23 '#'
    {0x24,0x2A,0x7F,0x2A,0x12,0x00,0x00,0x00}, // 0x24 '$'
    {0x23,0x13,0x08,0x64,0x62,0x00,0x00,0x00}, // 0x25 '%'
    {0x36,0x49,0x55,0x22,0x50,0x00,0x00,0x00}, // 0x26 '&'
    {0x00,0x05,0x03,0x00,0x00,0x00,0x00,0x00}, // 0x27 '''
    {0x00,0x1C,0x22,0x41,0x00,0x00,0x00,0x00}, // 0x28 '('
    {0x00,0x41,0x22,0x1C,0x00,0x00,0x00,0x00}, // 0x29 ')'
    {0x14,0x08,0x3E,0x08,0x14,0x00,0x00,0x00}, // 0x2A '*'
    {0x08,0x08,0x3E,0x08,0x08,0x00,0x00,0x00}, // 0x2B '+'
    {0x00,0x50,0x30,0x00,0x00,0x00,0x00,0x00}, // 0x2C ','
    {0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00}, // 0x2D '-'
    {0x00,0x60,0x60,0x00,0x00,0x00,0x00,0x00}, // 0x2E '.'
    {0x20,0x10,0x08,0x04,0x02,0x00,0x00,0x00}, // 0x2F '/'
    {0x3E,0x51,0x49,0x45,0x3E,0x00,0x00,0x00}, // 0x30 '0'
    {0x00,0x42,0x7F,0x40,0x00,0x00,0x00,0x00}, // 0x31 '1'
    {0x42,0x61,0x51,0x49,0x46,0x00,0x00,0x00}, // 0x32 '2'
    {0x21,0x41,0x45,0x4B,0x31,0x00,0x00,0x00}, // 0x33 '3'
    {0x18,0x14,0x12,0x7F,0x10,0x00,0x00,0x00}, // 0x34 '4'
    {0x27,0x45,0x45,0x45,0x39,0x00,0x00,0x00}, // 0x35 '5'
    {0x3C,0x4A,0x49,0x49,0x30,0x00,0x00,0x00}, // 0x36 '6'
    {0x01,0x71,0x09,0x05,0x03,0x00,0x00,0x00}, // 0x37 '7'
    {0x36,0x49,0x49,0x49,0x36,0x00,0x00,0x00}, // 0x38 '8'
    {0x06,0x49,0x49,0x29,0x1E,0x00,0x00,0x00}, // 0x39 '9'
    {0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00}, // 0x3A ':'
    {0x00,0x56,0x36,0x00,0x00,0x00,0x00,0x00}, // 0x3B ';'
    {0x08,0x14,0x22,0x41,0x00,0x00,0x00,0x00}, // 0x3C '<'
    {0x14,0x14,0x14,0x14,0x14,0x00,0x00,0x00}, // 0x3D '='
    {0x41,0x22,0x14,0x08,0x00,0x00,0x00,0x00}, // 0x3E '>'
    {0x02,0x01,0x51,0x09,0x06,0x00,0x00,0x00}, // 0x3F '?'
    {0x32,0x49,0x79,0x41,0x3E,0x00,0x00,0x00}, // 0x40 '@'
    {0x7E,0x11,0x11,0x11,0x7E,0x00,0x00,0x00}, // 0x41 'A'
    {0x7F,0x49,0x49,0x49,0x36,0x00,0x00,0x00}, // 0x42 'B'
    {0x3E,0x41,0x41,0x41,0x22,0x00,0x00,0x00}, // 0x43 'C'
    {0x7F,0x41,0x41,0x22,0x1C,0x00,0x00,0x00}, // 0x44 'D'
    {0x7F,0x49,0x49,0x49,0x41,0x00,0x00,0x00}, // 0x45 'E'
    {0x7F,0x09,0x09,0x09,0x01,0x00,0x00,0x00}, // 0x46 'F'
    {0x3E,0x41,0x49,0x49,0x7A,0x00,0x00,0x00}, // 0x47 'G'
    {0x7F,0x08,0x08,0x08,0x7F,0x00,0x00,0x00}, // 0x48 'H'
    {0x00,0x41,0x7F,0x41,0x00,0x00,0x00,0x00}, // 0x49 'I'
    {0x20,0x40,0x41,0x3F,0x01,0x00,0x00,0x00}, // 0x4A 'J'
    {0x7F,0x08,0x14,0x22,0x41,0x00,0x00,0x00}, // 0x4B 'K'
    {0x7F,0x40,0x40,0x40,0x40,0x00,0x00,0x00}, // 0x4C 'L'
    {0x7F,0x02,0x04,0x02,0x7F,0x00,0x00,0x00}, // 0x4D 'M'
    {0x7F,0x04,0x08,0x10,0x7F,0x00,0x00,0x00}, // 0x4E 'N'
    {0x3E,0x41,0x41,0x41,0x3E,0x00,0x00,0x00}, // 0x4F 'O'
    {0x7F,0x09,0x09,0x09,0x06,0x00,0x00,0x00}, // 0x50 'P'
    {0x3E,0x41,0x51,0x21,0x5E,0x00,0x00,0x00}, // 0x51 'Q'
    {0x7F,0x09,0x19,0x29,0x46,0x00,0x00,0x00}, // 0x52 'R'
    {0x46,0x49,0x49,0x49,0x31,0x00,0x00,0x00}, // 0x53 'S'
    {0x01,0x01,0x7F,0x01,0x01,0x00,0x00,0x00}, // 0x54 'T'
    {0x3F,0x40,0x40,0x40,0x3F,0x00,0x00,0x00}, // 0x55 'U'
    {0x1F,0x20,0x40,0x20,0x1F,0x00,0x00,0x00}, // 0x56 'V'
    {0x3F,0x40,0x38,0x40,0x3F,0x00,0x00,0x00}, // 0x57 'W'
    {0x63,0x14,0x08,0x14,0x63,0x00,0x00,0x00}, // 0x58 'X'
    {0x07,0x08,0x70,0x08,0x07,0x00,0x00,0x00}, // 0x59 'Y'
    {0x61,0x51,0x49,0x45,0x43,0x00,0x00,0x00}, // 0x5A 'Z'
    {0x00,0x7F,0x41,0x41,0x00,0x00,0x00,0x00}, // 0x5B '['
    {0x02,0x04,0x08,0x10,0x20,0x00,0x00,0x00}, // 0x5C '\'
    {0x00,0x41,0x41,0x7F,0x00,0x00,0x00,0x00}, // 0x5D ']'
    {0x04,0x02,0x01,0x02,0x04,0x00,0x00,0x00}, // 0x5E '^'
    {0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00}, // 0x5F '_'
    {0x00,0x03,0x07,0x00,0x00,0x00,0x00,0x00}, // 0x60 '`'
    {0x20,0x54,0x54,0x54,0x78,0x00,0x00,0x00}, // 0x61 'a'
    {0x7F,0x44,0x44,0x44,0x38,0x00,0x00,0x00}, // 0x62 'b'
    {0x38,0x44,0x44,0x44,0x20,0x00,0x00,0x00}, // 0x63 'c'
    {0x38,0x44,0x44,0x44,0x7F,0x00,0x00,0x00}, // 0x64 'd'
    {0x38,0x54,0x54,0x54,0x18,0x00,0x00,0x00}, // 0x65 'e'
    {0x08,0x7E,0x09,0x01,0x02,0x00,0x00,0x00}, // 0x66 'f'
    {0x0C,0x52,0x52,0x52,0x3E,0x00,0x00,0x00}, // 0x67 'g'
    {0x7F,0x08,0x04,0x04,0x78,0x00,0x00,0x00}, // 0x68 'h'
    {0x00,0x44,0x7D,0x40,0x00,0x00,0x00,0x00}, // 0x69 'i'
    {0x20,0x40,0x44,0x3D,0x00,0x00,0x00,0x00}, // 0x6A 'j'
    {0x7F,0x10,0x28,0x44,0x00,0x00,0x00,0x00}, // 0x6B 'k'
    {0x00,0x41,0x7F,0x40,0x00,0x00,0x00,0x00}, // 0x6C 'l'
    {0x7C,0x04,0x18,0x04,0x78,0x00,0x00,0x00}, // 0x6D 'm'
    {0x7C,0x08,0x04,0x04,0x78,0x00,0x00,0x00}, // 0x6E 'n'
    {0x38,0x44,0x44,0x44,0x38,0x00,0x00,0x00}, // 0x6F 'o'
    {0x7C,0x14,0x14,0x14,0x08,0x00,0x00,0x00}, // 0x70 'p'
    {0x08,0x14,0x14,0x18,0x7C,0x00,0x00,0x00}, // 0x71 'q'
    {0x7C,0x08,0x04,0x04,0x08,0x00,0x00,0x00}, // 0x72 'r'
    {0x48,0x54,0x54,0x54,0x20,0x00,0x00,0x00}, // 0x73 's'
    {0x04,0x3F,0x44,0x40,0x20,0x00,0x00,0x00}, // 0x74 't'
    {0x3C,0x40,0x40,0x20,0x7C,0x00,0x00,0x00}, // 0x75 'u'
    {0x1C,0x20,0x40,0x20,0x1C,0x00,0x00,0x00}, // 0x76 'v'
    {0x3C,0x40,0x30,0x40,0x3C,0x00,0x00,0x00}, // 0x77 'w'
    {0x44,0x28,0x10,0x28,0x44,0x00,0x00,0x00}, // 0x78 'x'
    {0x0C,0x50,0x50,0x50,0x3C,0x00,0x00,0x00}, // 0x79 'y'
    {0x44,0x64,0x54,0x4C,0x44,0x00,0x00,0x00}, // 0x7A 'z'
    {0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00}, // 0x7B '{'
    {0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00}, // 0x7C '|'
    {0x00,0x41,0x36,0x08,0x00,0x00,0x00,0x00}, // 0x7D '}'
    {0x10,0x08,0x08,0x10,0x08,0x00,0x00,0x00}  // 0x7E '~'
};

static void oled_write_glyph(const uint8_t *g, uint8_t page, uint8_t col) {
    oled_set_pos(page, col);
    i2c_write_data((uint8_t*)g, 8);
}

static void oled_write_char_at(char c, uint8_t page, uint8_t col) {
    if (c < 32 || c > 126) c = ' ';
    const uint8_t *g = font8x8_basic[(uint8_t)c - 32];
    oled_set_pos(page, col);
    i2c_write_data(g, 8);
}

static void oled_write_string_at(uint8_t page, uint8_t col, const char* str) {
    while (*str && col + 8 <= OLED_WIDTH) {
        oled_write_char_at(*str, page, col);
        col += 8;
        str++;
    }
}

void app_main(void) {
    ESP_LOGI(TAG, "SSD1315 text demo start");

    i2c_init();
    vTaskDelay(pdMS_TO_TICKS(20));

    i2c_scan();

    oled_init();

    ESP_LOGI(TAG, "Fill screen with 0xFF (all ON) for 500ms");
    oled_fill_screen(0xFF);
    vTaskDelay(pdMS_TO_TICKS(500));

    ESP_LOGI(TAG, "Fill screen with 0x00 (all OFF)");
    oled_fill_screen(0x00);
    vTaskDelay(pdMS_TO_TICKS(100));

    ESP_LOGI(TAG, "Display sample strings");
    oled_write_string_at(0, 0, "Hello, ESP32!");
    oled_write_string_at(1, 0, "SSD1315 128x64");
    oled_write_string_at(2, 0, "Temp: 23C  Hum:45%");
    oled_write_string_at(3, 0, "Display Ready");

    ESP_LOGI(TAG, "Demo finished");
}